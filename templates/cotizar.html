{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Progreso -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar" role="progressbar" style="width: 25%;"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-primary">Destino</span>
                        <span>Viajeros</span>
                        <span class="text-muted">Fechas</span>
                        <span class="text-muted">Personalizar</span>
                        <span class="text-muted">Confirmar</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Formulario de Cotizaci√≥n -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">üìù Personaliza tu Viaje</h4>
                        </div>
                        <div class="card-body">
                            <form id="form-cotizacion" action="{{ url_for('procesar_cotizacion') }}" method="POST">
                                <!-- Paso 1: Destino -->
                                <div class="cotizacion-paso active" id="paso-destino">
                                    <h5>1. Selecciona tu Destino</h5>
                                    <div class="row g-3">
                                        {% for key, tour in tours.items() %}
                                        <div class="col-md-6">
                                            <div class="destino-option card h-100">
                                                <input type="radio" name="pais" value="{{ key }}" id="destino-{{ key }}" class="d-none" required>
                                                <label for="destino-{{ key }}" class="card-body text-center cursor-pointer">
                                                    <img src="{{ tour.imagen }}" alt="{{ tour.nombre }}" class="img-fluid rounded mb-2" style="height: 100px; object-fit: cover;">
                                                    <h6>{{ tour.nombre }}</h6>
                                                    <p class="text-muted small mb-1">{{ tour.pais }}</p>
                                                    <p class="text-success fw-bold">Desde ${{ tour.precio_base }}</p>
                                                </label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Paso 2: Viajeros -->
                                <div class="cotizacion-paso d-none" id="paso-viajeros">
                                    <h5>2. Informaci√≥n de Viajeros</h5>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">N√∫mero de personas</label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   name="personas" 
                                                   min="1" 
                                                   max="20" 
                                                   value="2" 
                                                   required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">N√∫mero de noches</label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   name="noches" 
                                                   min="1" 
                                                   max="30" 
                                                   value="7" 
                                                   required>
                                        </div>
                                    </div>
                                </div>

                                <!-- Paso 3: Categor√≠a -->
                                <div class="cotizacion-paso d-none" id="paso-categoria">
                                    <h5>3. Selecciona la Categor√≠a</h5>
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <select class="form-select" name="categoria" required>
                                                <option value="economico">Econ√≥mico</option>
                                                <option value="estandar" selected>Est√°ndar</option>
                                                <option value="premium">Premium</option>
                                                <option value="lujo">Lujo</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Paso 4: Resumen -->
                                <div class="cotizacion-paso d-none" id="paso-resumen">
                                    <h5>4. Resumen de tu Cotizaci√≥n</h5>
                                    <div class="alert alert-info">
                                        <h6>Detalles del viaje:</h6>
                                        <div id="resumen-detalles">
                                            <p>Selecciona un destino para ver los detalles</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botones de navegaci√≥n -->
                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-secondary btn-anterior d-none">
                                        ‚Üê Anterior
                                    </button>
                                    <button type="button" class="btn btn-primary btn-siguiente">
                                        Siguiente ‚Üí
                                    </button>
                                    <button type="submit" class="btn btn-success btn-finalizar d-none">
                                        üéâ Finalizar Cotizaci√≥n
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Resumen en Tiempo Real -->
                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üí∞ Resumen de Cotizaci√≥n</h5>
                        </div>
                        <div class="card-body">
                            <div id="resumen-cotizacion">
                                <p class="text-muted">Selecciona un destino para ver el precio</p>
                            </div>
                            <div class="mt-3 pt-3 border-top">
                                <div class="d-flex justify-content-between">
                                    <strong>Total estimado:</strong>
                                    <strong id="total-cotizacion">$0</strong>
                                </div>
                                <small class="text-muted">* Precio por persona</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let pasoActual = 1;
    const totalPasos = 4;

    // Datos de tours desde Flask (se leen desde un bloque JSON en el DOM para evitar Jinja dentro de JS)
    const toursDataEl = document.getElementById('tours-data');
    const tours = toursDataEl ? JSON.parse(toursDataEl.textContent || '{}') : {};

    // Navegaci√≥n entre pasos
    document.querySelector('.btn-siguiente').addEventListener('click', siguientePaso);
    document.querySelector('.btn-anterior').addEventListener('click', anteriorPaso);

    function siguientePaso() {
        if (validarPasoActual()) {
            if (pasoActual < totalPasos) {
                document.getElementById(`paso-${obtenerNombrePaso(pasoActual)}`).classList.add('d-none');
                pasoActual++;
                document.getElementById(`paso-${obtenerNombrePaso(pasoActual)}`).classList.remove('d-none');
                actualizarNavegacion();
                actualizarResumen();
            }
        }
    }

    function anteriorPaso() {
        if (pasoActual > 1) {
            document.getElementById(`paso-${obtenerNombrePaso(pasoActual)}`).classList.add('d-none');
            pasoActual--;
            document.getElementById(`paso-${obtenerNombrePaso(pasoActual)}`).classList.remove('d-none');
            actualizarNavegacion();
        }
    }

    function obtenerNombrePaso(numero) {
        const pasos = ['destino', 'viajeros', 'categoria', 'resumen'];
        return pasos[numero - 1];
    }

    function validarPasoActual() {
        if (pasoActual === 1) {
            const destinoSeleccionado = document.querySelector('input[name="pais"]:checked');
            if (!destinoSeleccionado) {
                alert('Por favor selecciona un destino');
                return false;
            }
        }
        return true;
    }

    function actualizarNavegacion() {
        const btnAnterior = document.querySelector('.btn-anterior');
        const btnSiguiente = document.querySelector('.btn-siguiente');
        const btnFinalizar = document.querySelector('.btn-finalizar');

        btnAnterior.classList.toggle('d-none', pasoActual === 1);
        btnSiguiente.classList.toggle('d-none', pasoActual === totalPasos);
        btnFinalizar.classList.toggle('d-none', pasoActual !== totalPasos);
    }

    function actualizarResumen() {
        const destinoSeleccionado = document.querySelector('input[name="pais"]:checked');
        const personas = document.querySelector('input[name="personas"]')?.value || 2;
        const noches = document.querySelector('input[name="noches"]')?.value || 7;
        const categoria = document.querySelector('select[name="categoria"]')?.value || 'estandar';

        if (destinoSeleccionado) {
            const tour = tours[destinoSeleccionado.value];
            const multiplicadores = {
                'economico': 0.8,
                'estandar': 1.0,
                'premium': 1.5,
                'lujo': 2.0
            };
            
            const precioFinal = tour.precio_base * multiplicadores[categoria] * personas * (noches / 7);
            
            // Actualizar resumen lateral
            document.getElementById('resumen-cotizacion').innerHTML = `
                <div class="mb-2">
                    <strong>Destino:</strong> ${tour.nombre}
                </div>
                <div class="mb-2">
                    <strong>Personas:</strong> ${personas}
                </div>
                <div class="mb-2">
                    <strong>Noches:</strong> ${noches}
                </div>
                <div class="mb-2">
                    <strong>Categor√≠a:</strong> ${categoria.charAt(0).toUpperCase() + categoria.slice(1)}
                </div>
            `;
            
            document.getElementById('total-cotizacion').textContent = `$${Math.round(precioFinal)}`;

            // Actualizar resumen en paso 4
            if (pasoActual === 4) {
                document.getElementById('resumen-detalles').innerHTML = `
                    <div class="mb-2">
                        <strong>Destino:</strong> ${tour.nombre} - ${tour.pais}
                    </div>
                    <div class="mb-2">
                        <strong>Duraci√≥n:</strong> ${tour.duracion}
                    </div>
                    <div class="mb-2">
                        <strong>Viajeros:</strong> ${personas} personas
                    </div>
                    <div class="mb-2">
                        <strong>Estad√≠a:</strong> ${noches} noches
                    </div>
                    <div class="mb-2">
                        <strong>Categor√≠a:</strong> ${categoria.charAt(0).toUpperCase() + categoria.slice(1)}
                    </div>
                    <div class="mt-3 p-2 bg-light rounded">
                        <strong>Total: $${Math.round(precioFinal)} USD</strong>
                    </div>
                `;
            }
        }
    }

    // Event listeners para actualizaci√≥n en tiempo real
    document.querySelectorAll('input[name="pais"]').forEach(radio => {
        radio.addEventListener('change', function() {
            actualizarResumen();
        });
    });

    document.querySelectorAll('input[name="personas"], input[name="noches"], select[name="categoria"]').forEach(element => {
        element.addEventListener('change', actualizarResumen);
        element.addEventListener('input', actualizarResumen);
    });

    // Inicializar resumen
    actualizarResumen();
});
</script>

<!-- Tours JSON embebido (se parsea en JS) -->
<div id="tours-data" style="display:none;">{{ tours | tojson }}</div>

<style>
.destino-option {
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.destino-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.destino-option input:checked + label {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.cursor-pointer {
    cursor: pointer;
}
</style>
{% endblock %}